{% extends "base.html" %}
{% block title %}Marketplace{% endblock %}

{% block content %}
<style>
  /* CSS remains the same - keeping your brand colors and styling */
  :root {
    --primary-color: #ff7a00;
    --secondary-color: #054e97;
    --primary-light: rgba(255, 122, 0, 0.1);
    --primary-medium: rgba(255, 122, 0, 0.3);
    --primary-strong: rgba(255, 122, 0, 0.8);
    --secondary-light: rgba(5, 78, 151, 0.1);
    --secondary-medium: rgba(5, 78, 151, 0.3);
    --secondary-strong: rgba(5, 78, 151, 0.8);
    --primary-gradient: linear-gradient(135deg, #ff7a00 0%, #ff8c00 100%);
    --secondary-gradient: linear-gradient(135deg, #ff7a00 0%, #ff7a00 100%);
    --hero-gradient: linear-gradient(135deg, #ff7a00 0%, #ff7a00 100%);
    --glass-bg: rgba(255, 255, 255, 0.95);
    --glass-border: rgba(255, 122, 0, 0.2);
    --text-primary: #1a1a1a;
    --text-secondary: #6b7280;
    --surface: #ffffff;
    --surface-hover: #f8fafc;
    --shadow-soft: 0 8px 30px rgba(255, 122, 0, 0.1);
    --shadow-hover: 0 15px 45px rgba(255, 122, 0, 0.15);
  }

  .marketplace-page {
    min-height: 100vh;
    background: linear-gradient(135deg, var(--primary-light) 0%, rgba(255, 255, 255, 0.98) 100%);
    padding: 15px 0;
  }

  html.dark-mode .marketplace-page {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  }

  .marketplace-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 16px;
  }

  .marketplace-header {
    text-align: center;
    margin-bottom: 20px;
    padding: 20px 16px;
    background: var(--surface);
    border-radius: 16px;
    box-shadow: var(--shadow-soft);
    position: relative;
    overflow: hidden;
    border: 2px solid var(--primary-light);
  }

  html.dark-mode .marketplace-header {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-color: rgba(255, 122, 0, 0.3);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }

  .marketplace-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--primary-gradient);
  }

  .marketplace-header h1 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 8px;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.2;
  }

  .marketplace-header p {
    font-size: 0.8rem;
    color: var(--text-secondary);
    max-width: 100%;
    margin: 0 auto;
    line-height: 1.3;
  }

  html.dark-mode .marketplace-header p {
    color: #cbd5e1;
  }

  .filter-section {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 24px;
    box-shadow: 0 4px 16px rgba(255, 122, 0, 0.08);
    border: 1.5px solid rgba(255, 122, 0, 0.15);
    box-sizing: border-box;
  }

  html.dark-mode .filter-section {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%);
    border-color: rgba(255, 122, 0, 0.3);
    box-shadow: 0 4px 16px rgba(255, 122, 0, 0.15);
  }

  .filter-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    justify-content: space-between;
    padding-bottom: 12px;
    border-bottom: 2px solid rgba(255, 122, 0, 0.1);
  }

  html.dark-mode .filter-header {
    border-bottom-color: rgba(255, 122, 0, 0.25);
  }

  .filter-header h3 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    color: var(--primary-color);
    margin: 0;
    z-index: 10;
    position: relative;
  }

  html.dark-mode .filter-header h3 {
    color: #ff9500;
  }

  .filter-icon {
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff8c00 100%);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
    box-shadow: 0 4px 12px rgba(255, 122, 0, 0.2);
    flex-shrink: 0;
  }

  .filter-toggle-btn {
    display: flex !important;
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff8c00 100%);
    border: none;
    color: white;
    font-size: 0.75rem;
    font-weight: 700;
    cursor: pointer;
    padding: 8px 16px;
    margin-left: auto;
    border-radius: 8px;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(255, 122, 0, 0.25);
    flex-shrink: 0;
    text-transform: uppercase;
    letter-spacing: 0.2px;
  }

  .filter-toggle-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 18px rgba(255, 122, 0, 0.35);
  }

  .filter-toggle-btn:active {
    transform: translateY(-1px);
  }

  .filter-toggle-btn::before {
    content: '‚ñº';
    font-size: 0.65rem;
    transition: transform 0.3s ease;
    display: inline-block;
  }

  .filter-toggle-btn.expanded::before {
    content: '‚ñ≤';
    transform: rotate(0deg);
  }

  .filter-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    align-items: start;
    transition: all 0.3s ease;
    max-height: 500px;
    overflow: visible;
    padding: 8px 0;
    box-sizing: border-box;
    grid-auto-flow: dense;
  }

  .filter-form.hidden {
    display: none !important;
    max-height: 0;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 0;
  }

  .form-group:has(.price-filter-group) {
    grid-column: 1 / -1;
  }

  .form-group:has(> div[style*="display: flex"]) {
    grid-column: 1 / -1;
  }

  .form-group label {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.2px;
    display: flex;
    align-items: center;
    gap: 2px;
  }

  html.dark-mode .filter-section .form-group label {
    color: #f1f5f9;
  }

  .form-input, .form-select {
    padding: 7px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.75rem;
    transition: all 0.3s ease;
    background: var(--surface);
    color: var(--text-primary);
    font-weight: 500;
    width: 100%;
    box-sizing: border-box;
  }

  html.dark-mode .filter-section .form-input,
  html.dark-mode .filter-section .form-select {
    background: #334155;
    border-color: #475569;
    color: #f1f5f9;
  }

  html.dark-mode .filter-section .form-input::placeholder {
    color: #94a3b8;
  }

  .form-input::placeholder {
    color: #9ca3af;
  }

  .form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--primary-color);
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.1);
    transform: translateY(-1px);
  }

  html.dark-mode .filter-section .form-input:focus,
  html.dark-mode .filter-section .form-select:focus {
    background: #334155;
    border-color: #ff9500;
    box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.2);
  }

  .price-filter-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .price-range-selector {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
  }

  .price-custom {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .price-input {
    padding: 7px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.75rem;
    transition: all 0.3s ease;
    background: var(--surface);
    color: var(--text-primary);
    width: 100%;
    box-sizing: border-box;
  }

  html.dark-mode .filter-section .price-input {
    background: #334155;
    border-color: #475569;
    color: #f1f5f9;
  }

  .price-input::placeholder {
    color: #9ca3af;
  }

  html.dark-mode .filter-section .price-input::placeholder {
    color: #94a3b8;
  }

  .price-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.1);
  }

  html.dark-mode .filter-section .price-input:focus {
    border-color: #ff9500;
    box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.2);
  }

  .price-toggle {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
    flex-wrap: wrap;
  }

  .toggle-btn {
    padding: 6px 10px;
    border: 1.5px solid #e5e7eb;
    background: var(--surface);
    color: var(--text-secondary);
    border-radius: 6px;
    font-size: 0.65rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    flex: 1 1 auto;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.05px;
    min-width: 60px;
    white-space: nowrap;
  }

  html.dark-mode .filter-section .toggle-btn {
    background: #1e293b;
    border-color: #475569;
    color: #cbd5e1;
  }

  .toggle-btn:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    background: rgba(255, 122, 0, 0.05);
  }

  html.dark-mode .filter-section .toggle-btn:hover {
    background: rgba(255, 149, 0, 0.15);
    border-color: #ff9500;
    color: #ff9500;
  }

  .toggle-btn.active {
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff8c00 100%);
    color: white;
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(255, 122, 0, 0.3);
    transform: translateY(-2px);
  }

  html.dark-mode .filter-section .toggle-btn.active {
    background: linear-gradient(135deg, #ff9500 0%, #ff8c00 100%);
    box-shadow: 0 4px 12px rgba(255, 149, 0, 0.4);
  }

  .filter-btn {
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff8c00 100%);
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(255, 122, 0, 0.25);
    text-transform: uppercase;
    letter-spacing: 0.2px;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    flex: 1;
    min-width: 140px;
  }

  html.dark-mode .filter-btn {
    background: linear-gradient(135deg, #ff9500 0%, #ff8c00 100%);
    box-shadow: 0 3px 10px rgba(255, 149, 0, 0.35);
  }

  .filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 122, 0, 0.4);
  }

  html.dark-mode .filter-btn:hover {
    box-shadow: 0 6px 16px rgba(255, 149, 0, 0.5);
  }

  .filter-btn:active {
    transform: translateY(0);
  }

  .clear-filters-btn {
    background: transparent;
    color: var(--text-secondary);
    padding: 8px 14px;
    border: 1.5px solid #d1d5db;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.15px;
    flex: 1;
    min-width: 140px;
  }

  .clear-filters-btn:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    background: rgba(255, 122, 0, 0.05);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(255, 122, 0, 0.15);
  }

  html.dark-mode .clear-filters-btn {
    color: #cbd5e1;
    border-color: #64748b;
  }

  html.dark-mode .clear-filters-btn:hover {
    border-color: #ff9500;
    color: #ff9500;
    background: rgba(255, 149, 0, 0.1);
  }

  .results-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding: 12px 16px;
    background: var(--surface);
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--primary-light);
  }

  html.dark-mode .results-info {
    background: #1e293b;
    border-color: #475569;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
  }

  .results-count {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.8rem;
  }

  html.dark-mode .results-count {
    color: #f1f5f9;
  }

  .view-toggle {
    display: flex;
    gap: 4px;
    background: var(--primary-light);
    border-radius: 8px;
    padding: 2px;
  }

  html.dark-mode .view-toggle {
    background: rgba(255, 149, 0, 0.15);
  }

  .view-btn {
    padding: 4px 8px;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-secondary);
    font-size: 0.7rem;
  }

  html.dark-mode .view-btn {
    color: #cbd5e1;
  }

  .view-btn.active {
    background: var(--surface);
    color: var(--primary-color);
    box-shadow: 0 2px 6px var(--primary-medium);
    font-weight: 600;
  }

  html.dark-mode .view-btn.active {
    background: rgba(255, 149, 0, 0.2);
    color: #ff9500;
    box-shadow: 0 2px 6px rgba(255, 149, 0, 0.2);
  }

  .marketplace-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 30px;
  }

  .marketplace-grid.compact {
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  .marketplace-item {
    background: var(--surface);
    border-radius: 12px;
    overflow: visible;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-soft);
    border: 3px solid var(--primary-color);
    position: relative;
    cursor: pointer;
    perspective: 1000px;
    /* REMOVED: opacity and transform that were hiding items */
  }

  html.dark-mode .marketplace-item {
    background: #1e293b;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    border-color: rgba(255, 122, 0, 0.5);
  }

  .marketplace-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 35px var(--primary-medium);
    border-color: var(--primary-color);
  }

  .item-image-container {
    position: relative;
    overflow: visible;
    height: 120px;
    border-radius: 12px;
  }

  .marketplace-grid.compact .item-image-container {
    height: 100px;
  }

  .marketplace-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 12px;
  }

  /* Fade animation for carousel */
  @keyframes fadeIn {
    0% { opacity: 0; }
    100% { opacity: 1; }
  }

  .item-carousel-img {
    animation: fadeIn 0.4s ease-in-out;
  }

  .item-badge {
    position: absolute;
    top: 6px;
    right: 6px;
    background: var(--primary-gradient);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    box-shadow: 0 2px 8px var(--primary-medium);
  }

  .image-counter {
    position: absolute;
    bottom: 6px;
    left: 6px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.65rem;
    font-weight: 500;
    backdrop-filter: blur(8px);
  }

  .item-content {
    padding: 12px;
  }

  .marketplace-grid.compact .item-content {
    padding: 10px;
  }

  .item-title {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    margin: 0 0 8px 0;
    color: var(--text-primary);
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    height: 2.4em;
  }

  html.dark-mode .item-title {
    color: #f1f5f9;
  }

  .marketplace-grid.compact .item-title {
    font-size: 0.8rem;
    margin-bottom: 6px;
    height: 2.2em;
  }

  .item-details {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 10px;
  }

  .item-detail {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.7rem;
    color: var(--text-secondary);
  }

  html.dark-mode .item-detail {
    color: #cbd5e1;
  }

  .detail-icon {
    width: 14px;
    height: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .item-value {
    font-size: 1rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 10px;
  }

  .marketplace-grid.compact .item-value {
    font-size: 0.9rem;
    margin-bottom: 8px;
  }

  .item-actions {
    display: flex;
    gap: 6px;
  }

  .btn-primary {
    flex: 1;
    background: var(--primary-gradient);
    color: white;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    text-align: center;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    box-shadow: 0 3px 10px var(--primary-medium);
    font-size: 0.7rem;
  }

  .marketplace-grid.compact .btn-primary {
    padding: 6px 10px;
    font-size: 0.65rem;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 5px 15px var(--primary-medium);
  }

  .btn-secondary {
    width: 32px;
    height: 32px;
    background: var(--primary-light);
    border: 1px solid var(--primary-medium);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-secondary);
  }

  html.dark-mode .marketplace-item .btn-secondary {
    background: rgba(255, 149, 0, 0.15);
    border-color: #475569;
    color: #cbd5e1;
  }

  .marketplace-grid.compact .btn-secondary {
    width: 28px;
    height: 28px;
  }

  .btn-secondary:hover {
    background: var(--secondary-gradient);
    border-color: var(--secondary-color);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 3px 10px var(--secondary-medium);
  }

  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 30px 20px;
    background: var(--surface);
    border-radius: 12px;
    box-shadow: var(--shadow-soft);
    border: 1.5px solid var(--primary-light);
  }

  html.dark-mode .empty-state {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-color: rgba(255, 122, 0, 0.3);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }

  .empty-icon {
    width: 50px;
    height: 50px;
    background: var(--primary-light);
    border: 1.5px solid var(--primary-medium);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
    font-size: 1.2rem;
    color: var(--primary-color);
  }

  html.dark-mode .empty-icon {
    background: rgba(255, 149, 0, 0.15);
    border-color: #475569;
    color: #ff9500;
  }

  .empty-title {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 6px;
  }

  html.dark-mode .empty-title {
    color: #f1f5f9;
  }

  .empty-description {
    color: var(--text-secondary);
    font-size: 0.8rem;
    margin-bottom: 16px;
    line-height: 1.3;
  }

  html.dark-mode .empty-description {
    color: #cbd5e1;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 30px;
    padding: 16px;
    background: var(--surface);
    border-radius: 12px;
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--primary-light);
  }

  html.dark-mode .pagination {
    background: #1e293b;
    border-color: #475569;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
  }

  .pagination-btn {
    padding: 8px 12px;
    border: 1.5px solid var(--primary-light);
    background: var(--surface);
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
  }

  html.dark-mode .pagination-btn {
    background: #334155;
    border-color: #475569;
    color: #cbd5e1;
  }

  .pagination-btn:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: translateY(-1px);
    box-shadow: 0 3px 10px var(--primary-light);
  }

  html.dark-mode .pagination-btn:hover {
    border-color: #ff9500;
    color: #ff9500;
    box-shadow: 0 3px 10px rgba(255, 149, 0, 0.2);
  }

  .pagination-btn.active {
    background: var(--primary-gradient);
    border-color: transparent;
    color: white;
    box-shadow: 0 3px 10px var(--primary-medium);
  }

  .pagination-info {
    padding: 0 12px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.75rem;
  }

  html.dark-mode .pagination-info {
    color: #f1f5f9;
  }

  @media (min-width: 769px) {
    .marketplace-page { padding: 20px 0; }
    .marketplace-container { padding: 0 20px; }
    .marketplace-header { margin-bottom: 30px; padding: 30px 20px; border-radius: 20px; }
    .marketplace-header::before { height: 4px; }
    .marketplace-header h1 { font-size: 1.8rem; margin-bottom: 15px; }
    .marketplace-header p { font-size: 1rem; line-height: 1.4; }
    .filter-section { padding: 20px; margin-bottom: 25px; border-radius: 16px; }
    .filter-header { gap: 12px; margin-bottom: 20px; }
    .filter-header h3 { font-size: 1.2rem; }
    .filter-icon { width: 36px; height: 36px; border-radius: 10px; font-size: 1.1rem; }
    .filter-form { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
    .form-group label { font-size: 0.85rem; }
    .form-input, .form-select { padding: 12px 16px; border-radius: 12px; font-size: 0.9rem; }
    .price-range-selector { grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .price-custom { gap: 8px; }
    .price-input { padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; }
    .price-toggle { gap: 8px; margin-bottom: 10px; }
    .toggle-btn { padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; flex: none; }
    .filter-btn { padding: 12px 20px; border-radius: 12px; font-size: 0.9rem; min-width: auto; flex: 0 1 auto; }
    .clear-filters-btn { padding: 12px 20px; border-radius: 12px; font-size: 0.9rem; gap: 6px; min-width: auto; flex: 0 1 auto; }
    .results-info { margin-bottom: 20px; padding: 15px 20px; border-radius: 12px; }
    .results-count { font-size: 0.9rem; }
    .view-toggle { gap: 8px; border-radius: 10px; padding: 3px; }
    .view-btn { padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; }
    .marketplace-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .marketplace-grid.compact { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
    .marketplace-item { border-radius: 16px; border-width: 2px; }
    .item-image-container { height: 180px; }
    .item-badge { top: 10px; right: 10px; padding: 4px 8px; border-radius: 15px; font-size: 0.7rem; }
    .item-content { padding: 18px; }
    .marketplace-grid.compact .item-content { padding: 12px; }
    .item-title { font-size: 1.1rem; margin-bottom: 12px; height: auto; -webkit-line-clamp: initial; line-clamp: initial; }
    .marketplace-grid.compact .item-title { font-size: 0.9rem; margin-bottom: 8px; }
    .item-details { gap: 8px; margin-bottom: 15px; }
    .item-detail { gap: 8px; font-size: 0.85rem; }
    .detail-icon { width: 18px; height: 18px; }
    .item-value { font-size: 1.3rem; margin-bottom: 15px; }
    .marketplace-grid.compact .item-value { font-size: 1rem; margin-bottom: 10px; }
    .item-actions { gap: 8px; }
    .btn-primary { padding: 10px 16px; border-radius: 10px; gap: 6px; font-size: 0.85rem; }
    .marketplace-grid.compact .btn-primary { padding: 8px 12px; font-size: 0.75rem; }
    .btn-secondary { width: 42px; height: 42px; border-radius: 10px; }
    .marketplace-grid.compact .btn-secondary { width: 36px; height: 36px; }
    .empty-state { padding: 50px 30px; border-radius: 16px; border-width: 2px; }
    .empty-icon { width: 60px; height: 60px; margin-bottom: 15px; font-size: 1.5rem; border-width: 2px; }
    .empty-title { font-size: 1.3rem; margin-bottom: 8px; }
    .empty-description { font-size: 0.9rem; margin-bottom: 20px; }
    .pagination { gap: 12px; margin-top: 40px; padding: 20px; border-radius: 16px; }
    .pagination-btn { padding: 10px 16px; border-radius: 10px; gap: 6px; font-size: 0.85rem; border-width: 2px; }
    .pagination-info { padding: 0 15px; font-size: 0.85rem; }
  }

  @media (min-width: 1200px) {
    .marketplace-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
    .marketplace-grid.compact { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
  }

  @media (max-width: 768px) {
    .form-input:focus, .form-select:focus { transform: scale(1.01); }
    .filter-btn:active, .btn-primary:active { transform: scale(0.98); }
    .toggle-btn, .view-btn, .pagination-btn { min-height: 36px; }
    .btn-secondary { min-height: 32px; min-width: 32px; }
    .marketplace-grid.compact .btn-secondary { min-height: 28px; min-width: 28px; }
    
    /* Mobile filter optimizations */
    .filter-section { padding: 12px 14px; margin-bottom: 16px; border-radius: 10px; }
    .filter-header { flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .filter-header h3 { flex: 1 1 auto; font-size: 0.9rem; }
    .filter-icon { width: 24px; height: 24px; font-size: 0.8rem; }
    .filter-toggle-btn { padding: 6px 12px; font-size: 0.65rem; gap: 4px; }
    .filter-form { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; padding: 6px 0; }
    .form-group { gap: 4px; }
    .form-group label { font-size: 0.6rem; }
    .form-input, .form-select { padding: 6px 8px; border-radius: 4px; font-size: 0.7rem; }
    .form-group > div[style*="display: flex"] { flex-wrap: wrap; gap: 6px; }
    .price-filter-group { display: flex; flex-direction: column; gap: 8px; }
    .price-toggle { gap: 4px; margin-bottom: 4px; flex-wrap: wrap; }
    .toggle-btn { padding: 4px 6px; font-size: 0.55rem; min-width: 50px; flex: 1 1 calc(33.333% - 3px); }
    .price-range-selector { grid-template-columns: 1fr; }
    .price-custom { grid-template-columns: 1fr 1fr; gap: 6px; }
    .filter-btn, .clear-filters-btn { padding: 6px 10px; font-size: 0.65rem; min-width: 120px; flex: 1 1 calc(50% - 4px); }
    .price-input { padding: 6px 8px; border-radius: 4px; font-size: 0.7rem; }
    .results-info { margin-bottom: 12px; padding: 10px 12px; border-radius: 8px; }
    .results-count { font-size: 0.7rem; }
    .view-toggle { gap: 4px; border-radius: 6px; padding: 2px; }
    .view-btn { padding: 4px 8px; border-radius: 4px; font-size: 0.65rem; }
  }

  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  @media (prefers-contrast: high) {
    .form-input, .form-select { border-width: 2px; }
    .marketplace-item { border-width: 2px; }
  }

  /* ==================== AUTOCOMPLETE STYLES ==================== */

  .search-container {
    position: relative;
    width: 100%;
  }

  .autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--surface);
    border: 1.5px solid var(--primary-light);
    border-top: none;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
  }

  html.dark-mode .autocomplete-dropdown {
    background: #1e293b;
    border-color: #475569;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
  }

  .autocomplete-dropdown.show {
    display: block;
  }

  .autocomplete-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  html.dark-mode .autocomplete-item {
    border-bottom-color: #334155;
    color: #f1f5f9;
  }

  .autocomplete-item:hover {
    background: var(--primary-light);
    color: var(--primary-color);
  }

  html.dark-mode .autocomplete-item:hover {
    background: rgba(255, 149, 0, 0.15);
    color: #ff9500;
  }

  .autocomplete-item:last-child {
    border-bottom: none;
  }

  .autocomplete-icon {
    font-size: 1rem;
    color: var(--primary-color);
    flex-shrink: 0;
  }

  html.dark-mode .autocomplete-icon {
    color: #ff9500;
  }

  .autocomplete-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .autocomplete-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
  }

  html.dark-mode .autocomplete-name {
    color: #f1f5f9;
  }

  .autocomplete-category {
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  html.dark-mode .autocomplete-category {
    color: #cbd5e1;
  }

  .autocomplete-count {
    font-size: 0.7rem;
    background: var(--primary-light);
    color: var(--primary-color);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
  }

  html.dark-mode .autocomplete-count {
    background: rgba(255, 149, 0, 0.2);
    color: #ffb3b3;
  }

  .autocomplete-section-header {
    padding: 8px 16px;
    font-weight: 700;
    font-size: 0.7rem;
    text-transform: uppercase;
    color: var(--text-secondary);
    letter-spacing: 0.5px;
    background: #f9fafb;
    border-bottom: 1px solid var(--primary-light);
  }

  html.dark-mode .autocomplete-section-header {
    background: #334155;
    border-bottom-color: #475569;
    color: #cbd5e1;
  }

  .autocomplete-empty {
    padding: 20px 16px;
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.85rem;
  }

  html.dark-mode .autocomplete-empty {
    color: #cbd5e1;
  }

  .category-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }

  .category-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--primary-light);
    border: 1px solid var(--primary-medium);
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--primary-color);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  html.dark-mode .filter-section .category-pill {
    background: rgba(255, 149, 0, 0.15);
    border-color: #475569;
    color: #ffb3b3;
  }

  .category-pill:hover {
    background: var(--primary-gradient);
    border-color: var(--primary-color);
    color: white;
  }

  html.dark-mode .filter-section .category-pill:hover {
    background: linear-gradient(135deg, #ff9500 0%, #ff8c00 100%);
    border-color: #ff9500;
    color: white;
  }

  .category-pill-count {
    font-size: 0.65rem;
    opacity: 0.8;
    font-weight: 700;
  }

  .search-loading {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid var(--primary-light);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  html.dark-mode .search-loading {
    border-color: #475569;
    border-top-color: #ff9500;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .no-results-suggestion {
    padding: 12px 16px;
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.8rem;
  }

  html.dark-mode .no-results-suggestion {
    color: #cbd5e1;
  }

  /* ==================== RECOMMENDATIONS SECTION ==================== */

  .recommendations-section {
    background: var(--surface);
    border-radius: 16px;
    padding: 20px 16px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-soft);
    border: 2px solid var(--primary-light);
    position: relative;
    overflow: hidden;
  }

  html.dark-mode .recommendations-section {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-color: rgba(255, 122, 0, 0.3);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }

  .recommendations-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--primary-gradient);
  }

  .recommendations-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }

  .recommendations-icon {
    width: 36px;
    height: 36px;
    background: var(--primary-gradient);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    box-shadow: 0 4px 12px var(--primary-medium);
  }

  .recommendations-header h3 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
  }

  .recommendations-subtitle {
    color: var(--text-secondary);
    font-size: 0.75rem;
    font-weight: 500;
  }

  .recommendations-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .recommendation-item {
    background: var(--surface);
    border: 2px solid var(--primary-light);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  html.dark-mode .recommendation-item {
    background: #334155;
    border-color: #475569;
  }

  .recommendation-item:hover {
    border-color: var(--primary-color);
    box-shadow: 0 6px 16px var(--primary-light);
    transform: translateY(-2px);
  }

  .recommendation-image {
    width: 100%;
    height: 100px;
    object-fit: cover;
    background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-medium) 100%);
  }

  .recommendation-content {
    padding: 10px;
  }

  .recommendation-name {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-primary);
    display: -webkit-box;
    -webkit-line-clamp: 1;
    line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 4px;
  }

  html.dark-mode .recommendation-name {
    color: #f1f5f9;
  }

  .recommendation-category {
    font-size: 0.65rem;
    color: var(--text-secondary);
    margin-bottom: 6px;
  }

  html.dark-mode .recommendation-category {
    color: #cbd5e1;
  }

  .recommendation-value {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--primary-color);
  }

  .recommendations-empty {
    text-align: center;
    padding: 30px 20px;
    color: var(--text-secondary);
  }

  html.dark-mode .recommendations-empty {
    color: #cbd5e1;
  }

  .recommendations-loading {
    text-align: center;
    padding: 20px;
    color: var(--text-secondary);
  }

  html.dark-mode .recommendations-loading {
    color: #cbd5e1;
  }

  @media (min-width: 769px) {
    .recommendations-section {
      padding: 24px 20px;
      margin-bottom: 40px;
      border-radius: 20px;
    }

    .recommendations-icon {
      width: 44px;
      height: 44px;
      font-size: 1.3rem;
    }

    .recommendations-header h3 {
      font-size: 1.4rem;
    }

    .recommendations-grid {
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .recommendation-item {
      border-radius: 14px;
    }

    .recommendation-image {
      height: 140px;
    }

    .recommendation-content {
      padding: 12px;
    }

    .recommendation-name {
      font-size: 0.9rem;
      margin-bottom: 6px;
    }

    .recommendation-value {
      font-size: 1rem;
    }
  }

  /* ========== BACK TO TOP BUTTON ========== */
  #backToTopBtn {
    position: fixed;
    top: 70%;
    right: 20px;
    transform: translateY(-50%);
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff8c00 100%);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    z-index: 999;
    box-shadow: 0 4px 12px rgba(255, 122, 0, 0.4);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #backToTopBtn:hover {
    background: linear-gradient(135deg, #ff8c00, var(--primary-color));
    transform: translateY(-50%) translateX(-3px);
    box-shadow: 0 6px 16px rgba(255, 122, 0, 0.5);
  }

  @media (max-width: 640px) {
    #backToTopBtn {
      width: 40px;
      height: 40px;
      right: 15px;
      font-size: 1rem;
    }
  }

  @media (max-width: 768px) {
    .autocomplete-dropdown {
      max-height: 250px;
    }

    .autocomplete-item {
      padding: 10px 12px;
      font-size: 0.85rem;
    }

    .category-pills {
      gap: 6px;
    }

    .category-pill {
      padding: 4px 10px;
      font-size: 0.7rem;
    }

    .filter-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .filter-toggle-btn {
      display: flex !important;
    }

    /* Keep filter hidden on mobile by default */
    .filter-form.hidden {
      display: none !important;
    }

    .filter-form:not(.hidden) {
      display: grid;
    }
  }

  @media (max-width: 768px) and (orientation: landscape) and (max-height: 500px) {
    .marketplace-header { padding: 12px 16px; margin-bottom: 12px; }
    .marketplace-header h1 { font-size: 1.2rem; margin-bottom: 4px; }
    .marketplace-header p { font-size: 0.7rem; }
    .filter-section { padding: 12px; margin-bottom: 12px; }
    .item-image-container { height: 100px; }
    .marketplace-grid.compact .item-image-container { height: 80px; }
  }

  @media (max-width: 320px) {
    .marketplace-container { padding: 0 8px; }
    .marketplace-header { padding: 12px; }
    .filter-section { padding: 12px; }
    .marketplace-grid { gap: 8px; }
    .marketplace-grid.compact { gap: 6px; }
    .item-content { padding: 8px; }
    .marketplace-grid.compact .item-content { padding: 6px; }
    .item-title { font-size: 0.8rem; }
    .item-value { font-size: 0.9rem; }
    .btn-primary { padding: 6px 8px; font-size: 0.65rem; }
  }
</style>

<!-- Back to Top Button -->
<button id="backToTopBtn" title="Back to top" style="display: none; position: fixed; bottom: 30px; right: 20px; z-index: 80;">‚Üë</button>

<div class="marketplace-page">
  <div class="marketplace-container">
    <div class="marketplace-header">
      <h1>üõí Explore the Marketplace</h1>
      <p>For the sake of the "TESTING" items prices are not realistic. <br> Launching Soon. </p>
    </div>

    <div class="filter-section">
      <div class="filter-header">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div class="filter-icon">üîç</div>
          <h3>Shop your needs</h3>
        </div>
        <button type="button" class="filter-toggle-btn" id="filterToggleBtn">Filter Results</button>
      </div>

      <form method="GET" action="{{ url_for('marketplace.marketplace') }}" class="filter-form" id="filterForm">
        <div class="form-group">
          <label for="searchInput">Search Items</label>
          <div class="search-container">
            <input type="text" 
                   id="searchInput"
                   name="search" 
                   placeholder="What are you looking for?"
                   value="{{ request.args.get('search', '') }}"
                   class="search-input"
                   autocomplete="off" />
            <ul class="search-suggestions hidden" id="searchSuggestions"></ul>
          </div>
        </div>

        <div class="form-group">
          <label for="condition">Condition</label>
          <select name="condition" id="condition" class="form-select">
            <option value="">All Conditions</option>
            <option value="Brand New" {% if request.args.get('condition') == 'Brand New' %}selected{% endif %}>Brand New</option>
            <option value="Fairly Used" {% if request.args.get('condition') == 'Fairly Used' %}selected{% endif %}>Fairly Used</option>
          </select>
        </div>

        <div class="form-group">
          <label for="category">Category</label>
          <select name="category" id="category" class="form-select">
            <option value="">All Categories</option>
            {% set categories = [
              "Electronics", "Fashion / Clothing", "Footwear", "Home & Kitchen", "Beauty & Personal Care",
              "Sports & Outdoors", "Groceries", "Furniture", "Toys & Games", "Books & Stationery",
              "Health & Wellness", "Automotive", "Phones & Gadgets"
            ] %}
            {% for cat in categories %}
              <option value="{{ cat }}" {% if request.args.get('category') == cat %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="state">State</label>
          <select name="state" id="state" class="form-select">
            <option value="">All States</option>
            {% set states = [
              "Abia", "Adamawa", "Akwa Ibom", "Anambra", "Bauchi", "Bayelsa", "Benue", "Borno",
              "Cross River", "Delta", "Ebonyi", "Edo", "Ekiti", "Enugu", "Gombe", "Imo",
              "Jigawa", "Kaduna", "Kano", "Katsina", "Kebbi", "Kogi", "Kwara", "Lagos",
              "Nasarawa", "Niger", "Ogun", "Ondo", "Osun", "Oyo", "Plateau", "Rivers",
              "Sokoto", "Taraba", "Yobe", "Zamfara", "FCT Abuja"
            ] %}
            {% for state in states %}
              <option value="{{ state }}" {% if request.args.get('state') == state %}selected{% endif %}>{{ state }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>üí∞ Price Filter</label>
          <div class="price-filter-group">
            <div class="price-toggle">
              <button type="button" class="toggle-btn {% if not request.args.get('price_range') and not request.args.get('min_price') and not request.args.get('max_price') %}active{% endif %}" onclick="togglePriceFilter('all')">All</button>
              <button type="button" class="toggle-btn" onclick="togglePriceFilter('range')">Range</button>
              <button type="button" class="toggle-btn" onclick="togglePriceFilter('custom')">Custom</button>
            </div>

            <div id="priceRangeSelector" class="price-range-selector" style="display: none;">
              <select name="price_range" id="price_range" class="form-select">
                <option value="">Select Price Range</option>
                <option value="under-1000" {% if request.args.get('price_range') == 'under-1000' %}selected{% endif %}>Under ‚Ç¶1,000</option>
                <option value="1000-5000" {% if request.args.get('price_range') == '1000-5000' %}selected{% endif %}>‚Ç¶1,000 - ‚Ç¶5,000</option>
                <option value="5000-10000" {% if request.args.get('price_range') == '5000-10000' %}selected{% endif %}>‚Ç¶5,000 - ‚Ç¶10,000</option>
                <option value="10000-25000" {% if request.args.get('price_range') == '10000-25000' %}selected{% endif %}>‚Ç¶10,000 - ‚Ç¶25,000</option>
                <option value="25000-50000" {% if request.args.get('price_range') == '25000-50000' %}selected{% endif %}>‚Ç¶25,000 - ‚Ç¶50,000</option>
                <option value="over-50000" {% if request.args.get('price_range') == 'over-50000' %}selected{% endif %}>Over ‚Ç¶50,000</option>
              </select>
            </div>

            <div id="customPrice" class="price-custom" style="display: none;">
              <input type="number" 
                     name="min_price" 
                     placeholder="Min Price (‚Ç¶)"
                     value="{{ request.args.get('min_price', '') }}"
                     class="price-input"
                     min="0"
                     step="100" />
              <input type="number" 
                     name="max_price" 
                     placeholder="Max Price (‚Ç¶)"
                     value="{{ request.args.get('max_price', '') }}"
                     class="price-input"
                     min="0"
                     step="100" />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>&nbsp;</label>
          <div style="display: flex; gap: 8px;">
            <button type="submit" class="filter-btn">
              üîç Filter Results
            </button>
            <a href="{{ url_for('marketplace.marketplace') }}" class="clear-filters-btn">
              üîÑ Clear All
            </a>
          </div>
        </div>
      </form>
    </div>

    <!-- Recommendations Section (for logged-in users) - After filter section, before results -->
    {% if current_user.is_authenticated %}
    <div class="recommendations-section" id="recommendationsSection" style="display: none;">
      <div class="recommendations-header">
        <div class="recommendations-icon">‚≠ê</div>
        <div>
          <h3>Recommended For You</h3>
          <div class="recommendations-subtitle">Based on your browsing history</div>
        </div>
      </div>
      <div class="recommendations-grid" id="recommendationsGrid">
        <div class="recommendations-loading">‚è≥ Loading recommendations...</div>
      </div>
    </div>
    {% endif %}

    <div class="results-info">
      <div class="results-count">
        <strong>{{ items.total }}</strong> items found
        {% if request.args.get('search') or request.args.get('condition') or request.args.get('category') or request.args.get('state') or request.args.get('price_range') or request.args.get('min_price') or request.args.get('max_price') %}
          ‚Ä¢ Filtered results
        {% endif %}
      </div>
      <div class="view-toggle">
        <button class="view-btn active" onclick="toggleView('grid')">‚äû Grid</button>
        <button class="view-btn" onclick="toggleView('compact')">‚ä° Compact</button>
      </div>
    </div>

    <div class="marketplace-grid" id="itemsGrid">
      {% for item in items %}
        <!-- Build image array using namespace to support list mutation -->
        {% set ns = namespace(images=[]) %}
        {% if item.image_url %}
          {% set _ = ns.images.append(item.image_url) %}
        {% endif %}
        {% if item.images %}
          {% for img in item.images %}
            {% if img.image_url %}
              {% set _ = ns.images.append(img.image_url) %}
            {% endif %}
          {% endfor %}
        {% endif %}
        <!-- Final image URLs for carousel -->
        <div class="marketplace-item" data-item-url="{{ url_for('marketplace.view_item', item_id=item.id) }}" data-images='{{ ns.images | tojson }}'>
          <div class="item-image-container">
            {% if ns.images %}
              <img class="item-carousel-img" src="{{ ns.images[0] | image_url }}" alt="{{ item.name }}" loading="lazy" onerror="this.src='/static/placeholder.png'" />
            {% else %}
              <div style="height: 100%; background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-medium) 100%); display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 2rem;">üì∑</div>
            {% endif %}
            {% if ns.images|length > 1 %}
              <div class="image-counter">{{ ns.images|length }} images</div>
            {% endif %}
            <div class="item-badge">{{ item.condition }}</div>
          </div>
          
          <div class="item-content">
            <h4 class="item-title">{{ item.name }}</h4>
            <div class="item-location" style="color: #054e97; font-size: 0.65rem;">
              <span>Available in <strong>{{ item.location }}</strong></span>
            </div>
            <div class="item-value">‚Ç¶{{ "{:,.2f}".format(item.value) if item.value else 'Price not set' }}</div>
            
            <div class="item-actions">
              <a href="{{ url_for('marketplace.view_item', item_id=item.id) }}" class="btn-primary">
                üëÅÔ∏è View Details
              </a>
            </div> 
          </div>
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">üîç</div>
          <h3 class="empty-title">No items found</h3>
          <p class="empty-description">
            Try adjusting your search criteria or browse all available items.
          </p>
          <a href="{{ url_for('marketplace.marketplace') }}" class="btn-primary" style="display: inline-flex; width: auto;">
            üîÑ Clear Filters
          </a>
        </div>
      {% endfor %}  
    </div>

  </div>
</div>

<script>
  // Ensure all global DOM element references are initialized safely
  let searchInput, autocompleteDropdown, categoryPills;
  
  // ==================== SEARCH AUTOCOMPLETE ====================

  function initializeGlobalElements() {
    searchInput = document.getElementById('search');
    autocompleteDropdown = document.getElementById('autocompleteDropdown');
    categoryPills = document.getElementById('categoryPills');
  }
  
  let autocompleteTimeout;
  let categoryStats = {};

  // Initialize category stats on page load
  async function initializeCategoryStats() {
    try {
      const response = await fetch('/api/filters');
      const data = await response.json();
      categoryStats = data.categories || {};
    } catch (e) {
      console.error('Error loading category stats:', e);
    }
  }

  // Fetch and display search suggestions
  async function fetchSuggestions(query) {
    if (!query || query.length < 2) {
      autocompleteDropdown.classList.remove('show');
      categoryPills.style.display = 'none';
      return;
    }

    try {
      const response = await fetch(`/api/search-suggestions?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      displaySuggestions(data.suggestions);
    } catch (e) {
      console.error('Error fetching suggestions:', e);
      autocompleteDropdown.classList.remove('show');
    }
  }

  // Display search suggestions dropdown
  function displaySuggestions(suggestions) {
    if (suggestions.length === 0) {
      autocompleteDropdown.innerHTML = `
        <div class="no-results-suggestion">
          No suggestions found. Try different keywords.
        </div>
      `;
      autocompleteDropdown.classList.add('show');
      return;
    }

    let html = '';

    // Group by category
    const grouped = {};
    suggestions.forEach(s => {
      if (!grouped[s.category]) {
        grouped[s.category] = [];
      }
      grouped[s.category].push(s);
    });

    // Render grouped suggestions
    Object.entries(grouped).forEach(([category, items]) => {
      html += `<div class="autocomplete-section-header">${category} (${items.length})</div>`;
      items.forEach(item => {
        html += `
          <div class="autocomplete-item" onclick="selectSuggestion('${item.name.replace(/'/g, "\\'")}')">
            <div class="autocomplete-icon">üè∑Ô∏è</div>
            <div class="autocomplete-content">
              <div class="autocomplete-name">${escapeHtml(item.name)}</div>
              <div class="autocomplete-category">${item.category}</div>
            </div>
            <div class="autocomplete-count">${item.count}</div>
          </div>
        `;
      });
    });

    autocompleteDropdown.innerHTML = html;
    autocompleteDropdown.classList.add('show');
  }

  // Select suggestion and update search
  function selectSuggestion(name) {
    searchInput.value = name;
    autocompleteDropdown.classList.remove('show');
    categoryPills.style.display = 'none';
  }

  // Show trending categories
  function displayCategoryPills() {
    if (searchInput.value.length > 0) {
      categoryPills.style.display = 'none';
      return;
    }

    const topCategories = Object.entries(categoryStats)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);

    if (topCategories.length === 0) {
      categoryPills.style.display = 'none';
      return;
    }

    let html = '<strong style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 4px;">Browse Categories:</strong>';
    topCategories.forEach(([category, count]) => {
      html += `
        <button type="button" class="category-pill" onclick="filterByCategory('${category.replace(/'/g, "\\'")}')" title="${category}">
          <span>${category}</span>
          <span class="category-pill-count">${count}</span>
        </button>
      `;
    });

    categoryPills.innerHTML = html;
    categoryPills.style.display = 'block';
  }

  // Filter by category when pill clicked
  function filterByCategory(category) {
    document.getElementById('category').value = category;
    searchInput.focus();
    document.querySelector('.filter-btn').click();
  }

  // Initialize search event listeners
  function initializeSearchListeners() {
    if (!searchInput) return;
    
    // Debounced search input
    searchInput.addEventListener('input', function(e) {
      clearTimeout(autocompleteTimeout);
      const query = e.target.value.trim();

      if (query.length === 0) {
        displayCategoryPills();
        return;
      }

      autocompleteTimeout = setTimeout(() => {
        fetchSuggestions(query);
      }, 300);
    });

    // Show category pills on focus
    searchInput.addEventListener('focus', function() {
      if (this.value.length === 0) {
        displayCategoryPills();
      }
    });

    // Hide dropdown on blur
    searchInput.addEventListener('blur', function() {
      setTimeout(() => {
        if (autocompleteDropdown) {
          autocompleteDropdown.classList.remove('show');
        }
      }, 200);
    });

    // Close dropdown with Escape key
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (autocompleteDropdown) autocompleteDropdown.classList.remove('show');
        if (categoryPills) categoryPills.style.display = 'none';
      }
    });
  }

  // Helper function to escape HTML
  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }

  // ==================== RECOMMENDATIONS LOADER ====================

  async function loadRecommendations() {
    const section = document.getElementById('recommendationsSection');
    if (!section) return; // Not logged in

    try {
      const response = await fetch('/api/recommended');
      const data = await response.json();

      if (data.recommended && data.recommended.length > 0) {
        displayRecommendations(data.recommended);
        section.style.display = 'block';
      } else {
        section.style.display = 'none';
      }
    } catch (e) {
      console.error('Error loading recommendations:', e);
      section.style.display = 'none';
    }
  }

  function displayRecommendations(items) {
    const grid = document.getElementById('recommendationsGrid');
    if (!grid) return;

    function formatImageUrl(url) {
      if (!url) return '/static/placeholder.png';
      if (url.includes('/static/')) {
        return url.replace(/\/+/g, '/');
      }
      return `/static/uploads/${url.replace(/^\/+|\/+$/g, '')}`;
    }

    let html = '';
    items.slice(0, 8).forEach(item => {
      const imageUrl = formatImageUrl(item.image_url);
      html += `
        <div class="recommendation-item" onclick="window.location.href='/item/${item.id}'">
          <img src="${imageUrl}" 
               alt="${item.name}" 
               class="recommendation-image" 
               loading="lazy"
               onerror="this.src='/static/placeholder.png'" />
          <div class="recommendation-content">
            <div class="recommendation-name">${escapeHtml(item.name)}</div>
            <div class="recommendation-category">${item.category}</div>
            <div class="recommendation-value">‚Ç¶${(item.value || 0).toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
          </div>
        </div>
      `;
    });

    grid.innerHTML = html || '<div class="recommendations-empty">No recommendations available yet.</div>';
  }

  // ==================== ORIGINAL FUNCTIONS ====================

  let currentPriceFilter = 'all';

  function togglePriceFilter(filterType) {
    document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('priceRangeSelector').style.display = 'none';
    document.getElementById('customPrice').style.display = 'none';
    
    document.getElementById('price_range').value = '';
    document.querySelector('input[name="min_price"]').value = '';
    document.querySelector('input[name="max_price"]').value = '';
    
    if (filterType === 'range') {
      document.getElementById('priceRangeSelector').style.display = 'block';
    } else if (filterType === 'custom') {
      document.getElementById('customPrice').style.display = 'block';
    }
    
    currentPriceFilter = filterType;
  }

  function toggleView(viewType) {
    const grid = document.getElementById('itemsGrid');
    const buttons = document.querySelectorAll('.view-btn');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (viewType === 'compact') {
      grid.classList.add('compact');
    } else {
      grid.classList.remove('compact');
    }
  }

  // Initialize price filter based on URL parameters
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const priceRange = urlParams.get('price_range');
    const minPrice = urlParams.get('min_price');
    const maxPrice = urlParams.get('max_price');
    
    if (priceRange) {
      document.querySelector('.toggle-btn[onclick*="range"]').classList.add('active');
      document.querySelector('.toggle-btn[onclick*="all"]').classList.remove('active');
      document.getElementById('priceRangeSelector').style.display = 'block';
      currentPriceFilter = 'range';
    } else if (minPrice || maxPrice) {
      document.querySelector('.toggle-btn[onclick*="custom"]').classList.add('active');
      document.querySelector('.toggle-btn[onclick*="all"]').classList.remove('active');
      document.getElementById('customPrice').style.display = 'block';
      currentPriceFilter = 'custom';
    }
  });

  // Form validation with debounced submit
  const form = document.querySelector('form');
  let submitTimeout;
  
  form.addEventListener('submit', function(e) {
    if (currentPriceFilter === 'custom') {
      const minPrice = parseFloat(document.querySelector('input[name="min_price"]').value) || 0;
      const maxPrice = parseFloat(document.querySelector('input[name="max_price"]').value) || 0;
      
      if (maxPrice > 0 && minPrice > maxPrice) {
        e.preventDefault();
        alert('Minimum price cannot be greater than maximum price.');
        return false;
      }
    }
    
    const button = this.querySelector('.filter-btn');
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ Searching...';
    button.disabled = true;
    
    clearTimeout(submitTimeout);
    submitTimeout = setTimeout(() => {
      button.innerHTML = originalText;
      button.disabled = false;
    }, 3000);
  });

  // Simplified price input formatting (removed complex formatting)
  document.querySelectorAll('.price-input').forEach(input => {
    input.addEventListener('change', function() {
      if (this.value) {
        document.querySelector('select[name="price_range"]').value = '';
      }
    });
  });

  document.querySelector('select[name="price_range"]').addEventListener('change', function() {
    if (this.value) {
      document.querySelector('input[name="min_price"]').value = '';
      document.querySelector('input[name="max_price"]').value = '';
    }
  });

  // Keyboard shortcut for search (Ctrl/Cmd + K)
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      document.getElementById('search').focus();
    }
    
    if (e.key === 'Escape' && document.activeElement === document.getElementById('search')) {
      document.getElementById('search').value = '';
    }
  });

  // Smooth scroll for pagination
  document.querySelectorAll('.pagination-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  });

  // REMOVED: Intersection Observer animation code that was causing delays
  // REMOVED: Complex touch gesture handlers
  // REMOVED: Excessive scroll listeners
  
  // Add loading feedback to filter and button clicks
  document.querySelector('.filter-btn')?.addEventListener('click', function() {
    if (typeof showToast !== 'undefined') {
      showToast('Applying filters...', 'info');
    }
  });

  document.querySelector('.clear-filters-btn')?.addEventListener('click', function() {
    if (typeof showToast !== 'undefined') {
      showToast('Clearing filters...', 'info');
    }
  });

  // Handle marketplace item card clicks - make entire card clickable
  document.querySelectorAll('.marketplace-item').forEach(card => {
    card.addEventListener('click', function(e) {
      // Don't navigate if clicking on the action buttons area
      if (e.target.closest('.item-actions')) {
        return;
      }
      // Navigate to item details page
      const url = this.getAttribute('data-item-url');
      if (url) {
        window.location.href = url;
      }
    });
  });

  // Setup image carousel - cycle through uploaded images
  const setupImageCarousel = () => {
    console.log('=== setupImageCarousel called ===');
    const items = document.querySelectorAll('.marketplace-item');
    console.log('Found marketplace items:', items.length);
    
    items.forEach((card, index) => {
      const imagesData = card.getAttribute('data-images');
      console.log(`Item ${index} - data-images:`, imagesData);
      
      if (!imagesData) {
        console.log(`Item ${index} - Skipping, no images data`);
        return;
      }
      
      try {
        const images = JSON.parse(imagesData);
        console.log(`Item ${index} - Parsed images:`, images);
        
        if (images.length <= 1) {
          console.log(`Item ${index} - Skipping, only ${images.length} image(s)`);
          return;
        }
        
        const img = card.querySelector('.item-carousel-img');
        console.log(`Item ${index} - Found img element:`, !!img);
        
        if (!img) return;
        
        let currentIndex = 0;
        let cycleInterval = null;
        
        const cycleImages = () => {
          currentIndex = (currentIndex + 1) % images.length;
          // Apply image_url filter equivalent - prepend /static/uploads/ if needed
          let imgUrl = images[currentIndex];
          if (!imgUrl.startsWith('http') && !imgUrl.startsWith('/')) {
            imgUrl = '/static/uploads/' + imgUrl;
          }
          img.src = imgUrl;
          console.log('Cycling to image', currentIndex, ':', imgUrl);
        };
        
        // Start cycling when card comes into view
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              console.log('Card visible, starting carousel');
              if (!cycleInterval) {
                cycleInterval = setInterval(cycleImages, 2000); // Change image every 2 seconds
              }
            } else {
              // Stop cycling when card leaves view
              if (cycleInterval) {
                clearInterval(cycleInterval);
                cycleInterval = null;
              }
            }
          });
        }, { threshold: 0.1 });
        
        observer.observe(card);
        
        // Also cycle on hover
        card.addEventListener('mouseenter', () => {
          console.log('Hover in, faster cycling');
          if (cycleInterval) clearInterval(cycleInterval);
          cycleInterval = setInterval(cycleImages, 1500); // Faster on hover
        });
        
        card.addEventListener('mouseleave', () => {
          console.log('Hover out, resetting');
          if (cycleInterval) clearInterval(cycleInterval);
          currentIndex = 0;
          let imgUrl = images[0];
          if (!imgUrl.startsWith('http') && !imgUrl.startsWith('/')) {
            imgUrl = '/static/uploads/' + imgUrl;
          }
          img.src = imgUrl;
        });
      } catch (e) {
        console.error('Error parsing images data:', e);
      }
    });
  };

  // Initialize image carousel when page loads
  document.addEventListener('DOMContentLoaded', () => {
    setupImageCarousel();
  });
  
  // Also run immediately in case DOM is already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupImageCarousel);
  } else {
    setupImageCarousel();
  }

  // Reinitialize carousel after any dynamic content loads
  if (window.setupImageCarousel === undefined) {
    window.setupImageCarousel = setupImageCarousel;
  }

  // Add loading feedback to View Details buttons
  document.querySelectorAll('.btn-primary').forEach(btn => {
    if (btn.textContent.includes('View Details')) {
      btn.addEventListener('click', function(e) {
        if (typeof showLoading !== 'undefined') {
          showLoading('Loading item details...');
        }
      });
    }
  });

  // Add loading feedback to pagination links
  document.querySelectorAll('.pagination-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      if (typeof showLoading !== 'undefined') {
        showLoading('Loading page...');
      }
    });
  });
  
  // Keep minimal mobile improvements
  if (window.innerWidth <= 768) {
    document.querySelectorAll('button, .btn-primary, .btn-secondary').forEach(btn => {
      btn.addEventListener('touchstart', function() {
        this.style.transform = 'scale(0.95)';
      }, { passive: true });
      
      btn.addEventListener('touchend', function() {
        setTimeout(() => { this.style.transform = ''; }, 100);
      }, { passive: true });
    });
  }

  // ==================== BACK TO TOP BUTTON ====================
  // This will be initialized in DOMContentLoaded below

  // ==================== INITIALIZATION ====================
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üîµ DOMContentLoaded fired');
    
    // Initialize global elements first
    initializeGlobalElements();
    initializeSearchListeners();
    
    // Initialize category stats and recommendations
    initializeCategoryStats();
    loadRecommendations();
    
    // ========== FILTER TOGGLE ==========
    const filterToggleBtn = document.getElementById('filterToggleBtn');
    const filterForm = document.getElementById('filterForm');
    
    console.log('üîµ Filter elements:', { filterToggleBtn: !!filterToggleBtn, filterForm: !!filterForm });
    
    if (filterToggleBtn && filterForm) {
      // Make sure form is hidden initially
      filterForm.classList.add('hidden');
      console.log('‚úÖ Filter form hidden by default');
      
      // Toggle filter form visibility
      filterToggleBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const isHidden = filterForm.classList.contains('hidden');
        
        if (isHidden) {
          // Show the form
          filterForm.classList.remove('hidden');
          filterToggleBtn.classList.add('expanded');
          console.log('üü¢ Filter expanded');
        } else {
          // Hide the form
          filterForm.classList.add('hidden');
          filterToggleBtn.classList.remove('expanded');
          console.log('üü¢ Filter collapsed');
        }
      });

      // Update button display on resize
      window.addEventListener('resize', function() {
        filterToggleBtn.style.display = 'flex';
      });
    } else {
      console.error('‚ùå Filter elements not found!');
    }
    
    // ========== BACK TO TOP BUTTON ==========
    const backToTopBtn = document.getElementById('backToTopBtn');
    console.log('üîµ Back to top button:', !!backToTopBtn);

    if (backToTopBtn) {
      console.log('‚úÖ Back to top button found, initializing...');
      
      // Show button when user scrolls down
      const scrollHandler = function() {
        const scrollTop = window.scrollY || document.documentElement.scrollTop || document.body.scrollTop;
        if (scrollTop > 300) {
          if (backToTopBtn.style.display !== 'flex') {
            backToTopBtn.style.display = 'flex';
            console.log('üü¢ Scroll: Button shown (scrollTop: ' + scrollTop + ')');
          }
        } else {
          if (backToTopBtn.style.display !== 'none') {
            backToTopBtn.style.display = 'none';
            console.log('üü° Scroll: Button hidden (scrollTop: ' + scrollTop + ')');
          }
        }
      };
      
      window.addEventListener('scroll', scrollHandler, { passive: true });

      // Scroll to top when button is clicked
      backToTopBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üü¢ Back to top clicked!');
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    } else {
      console.error('‚ùå Back to top button not found!');
    }
    
    // Ensure filter is hidden by default
    if (filterForm && !filterForm.classList.contains('hidden')) {
      filterForm.classList.add('hidden');
    }
    
    console.log('üü¢ All initialization complete!');
  });
</script>
{% endblock %}