{% extends "base.html" %}

{% block title %}Security Settings - Account Management{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <!-- Security Score Card -->
            <div class="card border-primary mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="card-title">Your Security Score</h5>
                            <p class="text-muted">Based on your security settings and account activity</p>
                        </div>
                        <div class="col-md-4 text-center">
                            <div id="security-score" class="display-4 font-weight-bold text-primary">
                                {{ security_score }}/100
                            </div>
                            <small class="text-muted" id="score-status">Excellent</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Settings Navigation -->
            <div class="list-group mb-4">
                <a href="#security-preferences" data-toggle="list" class="list-group-item list-group-item-action active">
                    <i class="fas fa-shield-alt"></i> Security Preferences
                </a>
                <a href="#password" data-toggle="list" class="list-group-item list-group-item-action">
                    <i class="fas fa-key"></i> Password
                </a>
                <a href="#two-factor" data-toggle="list" class="list-group-item list-group-item-action">
                    <i class="fas fa-mobile-alt"></i> Two-Factor Authentication
                </a>
                <a href="#trusted-devices" data-toggle="list" class="list-group-item list-group-item-action">
                    <i class="fas fa-laptop"></i> Trusted Devices
                </a>
                <a href="#ip-whitelist" data-toggle="list" class="list-group-item list-group-item-action">
                    <i class="fas fa-network-wired"></i> IP Whitelist
                </a>
                <a href="#activity-log" data-toggle="list" class="list-group-item list-group-item-action">
                    <i class="fas fa-history"></i> Activity Log
                </a>
                <a href="#data-privacy" data-toggle="list" class="list-group-item list-group-item-action">
                    <i class="fas fa-user-secret"></i> Data & Privacy
                </a>
            </div>

            <!-- 1. Security Preferences -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Security Preferences</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('account.security_settings') }}">
                        {{ form.hidden_tag() }}
                        
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                {{ form.alert_on_new_device(class="custom-control-input") }}
                                <label class="custom-control-label" for="alert_on_new_device">
                                    Alert when new device logs in
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Receive email notification when a new device accesses your account
                            </small>
                        </div>

                        <div class="form-group mt-3">
                            <div class="custom-control custom-switch">
                                {{ form.alert_on_location_change(class="custom-control-input") }}
                                <label class="custom-control-label" for="alert_on_location_change">
                                    Alert on location change
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Receive notification if login comes from a different location
                            </small>
                        </div>

                        <div class="form-group mt-3">
                            <label for="password_strength_required">
                                <strong>Required Password Strength</strong>
                            </label>
                            {{ form.password_strength_required(class="form-control") }}
                            <small class="form-text text-muted">
                                <strong>Weak:</strong> 8+ characters | 
                                <strong>Medium:</strong> 8+ chars + numbers/special chars | 
                                <strong>Strong:</strong> 12+ chars + numbers + special chars
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </form>
                </div>
            </div>

            <!-- 2. Password -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-key"></i> Password</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        <strong>Last changed:</strong> 
                        {% if current_user.last_password_change %}
                            {{ current_user.last_password_change.strftime('%B %d, %Y at %I:%M %p') }}
                        {% else %}
                            Never
                        {% endif %}
                    </p>
                    <a href="{{ url_for('account.change_password_page') }}" class="btn btn-outline-primary">
                        <i class="fas fa-lock"></i> Change Password
                    </a>
                </div>
            </div>

            <!-- 3. Two-Factor Authentication -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-mobile-alt"></i> Two-Factor Authentication</h5>
                </div>
                <div class="card-body">
                    {% if current_user.two_factor_enabled %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> 
                            <strong>2FA is enabled</strong> - Your account is protected with two-factor authentication
                        </div>
                        <form method="POST" action="{{ url_for('account.disable_2fa_endpoint') }}" 
                              onsubmit="return confirm('Are you sure? This will reduce your account security.');">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-times"></i> Disable 2FA
                            </button>
                        </form>
                    {% else %}
                        <p class="text-muted">Add an extra layer of security to your account</p>
                        <a href="{{ url_for('account.setup_2fa') }}" class="btn btn-success">
                            <i class="fas fa-plus"></i> Enable 2FA
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- 4. Trusted Devices -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-laptop"></i> Trusted Devices</h5>
                </div>
                <div class="card-body">
                    {% if settings.trusted_devices %}
                        <div class="list-group">
                            {% for device in settings.trusted_devices %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{{ device.name }}</h6>
                                        <small class="text-muted">Added {{ device.date }}</small>
                                    </div>
                                    <form method="POST" action="{{ url_for('account.remove_device', index=loop.index0) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </form>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No trusted devices yet</p>
                    {% endif %}
                    <form method="POST" action="{{ url_for('account.add_device') }}" class="mt-3">
                        <input type="hidden" name="fingerprint" value="current">
                        <input type="text" name="name" placeholder="Device name (e.g., My Laptop)" class="form-control mb-2" required>
                        <button type="submit" class="btn btn-outline-success">
                            <i class="fas fa-plus"></i> Trust This Device
                        </button>
                    </form>
                </div>
            </div>

            <!-- 5. IP Whitelist -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-network-wired"></i> IP Whitelist</h5>
                </div>
                <div class="card-body">
                    {% if settings.ip_whitelist %}
                        <div class="list-group">
                            {% for ip_entry in settings.ip_whitelist %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{{ ip_entry.address }}</h6>
                                        <small class="text-muted">Added {{ ip_entry.date }}</small>
                                    </div>
                                    <form method="POST" action="{{ url_for('account.remove_ip_whitelist', ip_address=ip_entry.address) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </form>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No IPs whitelisted yet</p>
                    {% endif %}
                    <form method="POST" action="{{ url_for('account.add_ip_whitelist') }}" class="mt-3">
                        <button type="submit" class="btn btn-outline-success">
                            <i class="fas fa-plus"></i> Whitelist Current IP
                        </button>
                    </form>
                </div>
            </div>

            <!-- 6. Activity Log -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Activity Log</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">View and monitor all account activities</p>
                    <a href="{{ url_for('account.activity_log') }}" class="btn btn-outline-primary">
                        <i class="fas fa-eye"></i> View Activity Log
                    </a>
                </div>
            </div>

            <!-- 7. Data & Privacy -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user-secret"></i> Data & Privacy</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Export Your Data</h6>
                            <p class="text-muted small">Download all your data (GDPR compliant)</p>
                            <a href="{{ url_for('account.data_export') }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-download"></i> Request Export
                            </a>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger">Delete Account</h6>
                            <p class="text-muted small">Permanently delete your account (30-day recovery period)</p>
                            <a href="{{ url_for('account.delete_account') }}" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-trash"></i> Delete Account
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Update security score display
fetch('{{ url_for("account.api_security_score") }}')
    .then(r => r.json())
    .then(data => {
        document.getElementById('security-score').textContent = data.score + '/100';
        document.getElementById('score-status').textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
        document.getElementById('score-status').className = `text-${data.color}`;
    });
</script>
{% endblock %}
